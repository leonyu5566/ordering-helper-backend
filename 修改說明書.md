# ğŸ¯ ä¸­æ–‡æ‘˜è¦ä¿®å¾© - è©³ç´°ä¿®æ”¹èªªæ˜æ›¸

## ğŸ“‹ å•é¡Œæè¿°

ä½¿ç”¨è€…å›å ±ç³»çµ±åœ¨ç”Ÿæˆä¸­æ–‡æ‘˜è¦æ™‚å‡ºç¾ä»¥ä¸‹å•é¡Œï¼š
1. **ä¸­æ–‡æ‘˜è¦é¡¯ç¤ºè‹±æ–‡èœå**ï¼š`zh_items` è£¡é¢æ ¹æœ¬å°±æ˜¯è‹±æ–‡
2. **è½‰æ›å™¨è¦†å¯« original æ¬„ä½**ï¼šé˜²å‘†è½‰æ›å™¨æŠŠ `original` èˆ‡ `translated` éƒ½è¨­æˆè‹±æ–‡
3. **æ¬„ä½é¡›å€’å•é¡Œ**ï¼šæŸäº›æƒ…æ³ä¸‹ `original` æ˜¯è‹±æ–‡ï¼Œ`translated` æ˜¯ä¸­æ–‡

## ğŸ”§ å¾Œç«¯ä¿®å¾© (ordering-helper-backend)

### 1. æ–°å¢ä¸­æ–‡æª¢æ¸¬å‡½æ•¸

**æª”æ¡ˆ**: `app/api/helpers.py`

**æ–°å¢ç¨‹å¼ç¢¼**:
```python
def contains_cjk(text: str) -> bool:
    """
    æª¢æ¸¬æ–‡å­—æ˜¯å¦åŒ…å«ä¸­æ—¥éŸ“æ–‡å­—ï¼ˆCJKï¼‰
    ç”¨æ–¼åˆ¤æ–·æ˜¯å¦ç‚ºä¸­æ–‡èœå
    """
    if not text or not isinstance(text, str):
        return False
    
    # ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—ç¯„åœ
    cjk_ranges = [
        (0x4E00, 0x9FFF),   # åŸºæœ¬ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—
        (0x3400, 0x4DBF),   # ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å±•A
        (0x20000, 0x2A6DF), # ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å±•B
        (0x2A700, 0x2B73F), # ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å±•C
        (0x2B740, 0x2B81F), # ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å±•D
        (0x2B820, 0x2CEAF), # ä¸­æ—¥éŸ“çµ±ä¸€è¡¨æ„æ–‡å­—æ“´å±•E
        (0xF900, 0xFAFF),   # ä¸­æ—¥éŸ“ç›¸å®¹è¡¨æ„æ–‡å­—
        (0x2F800, 0x2FA1F), # ä¸­æ—¥éŸ“ç›¸å®¹è¡¨æ„æ–‡å­—è£œå……
    ]
    
    for char in text:
        char_code = ord(char)
        for start, end in cjk_ranges:
            if start <= char_code <= end:
                return True
    
    return False
```

### 2. æ–°å¢å®‰å…¨æœ¬åœ°åŒ–èœåå»ºç«‹å‡½æ•¸

**æª”æ¡ˆ**: `app/api/helpers.py`

**æ–°å¢ç¨‹å¼ç¢¼**:
```python
def safe_build_localised_name(raw_name: str, zh_name: str | None = None) -> Dict[str, str]:
    """
    å®‰å…¨å»ºç«‹æœ¬åœ°åŒ–èœå
    è‹¥å·²ç¶“æŠ“åˆ° OCR ä¸­æ–‡ (zh_name)ï¼Œå°±æ”¾åˆ° originalï¼›
    æ²’æœ‰ä¸­æ–‡æ‰ fallback åˆ° raw_nameã€‚
    
    Args:
        raw_name: åŸå§‹èœåï¼ˆå¯èƒ½æ˜¯è‹±æ–‡æˆ–ä¸­æ–‡ï¼‰
        zh_name: OCR æˆ– Gemini å–å¾—çš„ä¸­æ–‡èœå
    
    Returns:
        Dict with 'original' and 'translated' keys
    """
    if zh_name and contains_cjk(zh_name):
        # æœ‰ä¸­æ–‡èœåï¼Œä½¿ç”¨ä¸­æ–‡ä½œç‚º original
        return {
            'original': zh_name,
            'translated': raw_name
        }
    elif contains_cjk(raw_name):
        # raw_name æœ¬èº«å°±æ˜¯ä¸­æ–‡
        # å¦‚æœ zh_name å­˜åœ¨ä¸”ä¸æ˜¯ä¸­æ–‡ï¼Œä½¿ç”¨å®ƒä½œç‚ºç¿»è­¯
        translated_name = zh_name if zh_name and not contains_cjk(zh_name) else raw_name
        return {
            'original': raw_name,
            'translated': translated_name
        }
    else:
        # æ²’æœ‰ä¸­æ–‡ï¼Œå…ˆæŠŠ raw_name ç•¶ originalï¼Œå†è¦–èªè¨€ç¿»è­¯
        # å¦‚æœ zh_name å­˜åœ¨ä½†ä¸æ˜¯ä¸­æ–‡ï¼Œå¯èƒ½æ˜¯æœ‰ç”¨çš„ç¿»è­¯
        translated_name = zh_name if zh_name and not contains_cjk(zh_name) else raw_name
        return {
            'original': raw_name,
            'translated': translated_name
        }
```

### 3. æ”¹é€²é˜²å‘†è½‰æ›å™¨

**æª”æ¡ˆ**: `app/api/routes.py`

**ä¿®æ”¹å‰**:
```python
# èˆŠæ ¼å¼ï¼Œè½‰æ›æˆæ–°æ ¼å¼
# æª¢æŸ¥æ˜¯å¦æœ‰åŸå§‹ä¸­æ–‡èœåå’Œç¿»è­¯èœå
original_name = item.get('original_name') or item_name
translated_name = item.get('translated_name') or item.get('name') or item_name

simple_item = {
    'name': {
        'original': original_name,
        'translated': translated_name
    },
    'quantity': item.get('quantity') or item.get('qty') or 1,
    'price': item.get('price') or item.get('price_small') or 0
}
```

**ä¿®æ”¹å¾Œ**:
```python
# èˆŠæ ¼å¼ï¼Œä½¿ç”¨å®‰å…¨æœ¬åœ°åŒ–èœåå»ºç«‹å‡½æ•¸
# å„ªå…ˆä½¿ç”¨ OCR å–å¾—çš„ä¸­æ–‡èœå
from .helpers import safe_build_localised_name

ocr_name = item.get('ocr_name') or item.get('original_name')
raw_name = item.get('translated_name') or item.get('name') or item_name

localised_name = safe_build_localised_name(raw_name, ocr_name)

simple_item = {
    'name': localised_name,
    'quantity': item.get('quantity') or item.get('qty') or 1,
    'price': item.get('price') or item.get('price_small') or 0
}
```

### 4. ä¿è­· original æ¬„ä½

**æª”æ¡ˆ**: `app/api/helpers.py`

**ä¿®æ”¹å‰**:
```python
for item in order_request.items:
    # è¨ˆç®—å°è¨ˆ
    subtotal = item.price * item.quantity
    total_amount += subtotal
    
    # ä¸­æ–‡è¨‚å–®é …ç›®ï¼ˆä½¿ç”¨åŸå§‹ä¸­æ–‡èœåï¼‰
    zh_items.append({
        'name': item.name.original,
        'quantity': item.quantity,
        'price': item.price,
        'subtotal': subtotal
    })
```

**ä¿®æ”¹å¾Œ**:
```python
for item in order_request.items:
    # è¨ˆç®—å°è¨ˆ
    subtotal = item.price * item.quantity
    total_amount += subtotal
    
    # ä¿è­· original æ¬„ä½ï¼Œé¿å…è¢«è¦†å¯«
    # è‹¥åµæ¸¬åˆ° original æ˜¯è‹±æ–‡ä½† translated æ˜¯ä¸­æ–‡ï¼Œäº¤æ›ä¸€æ¬¡
    if not contains_cjk(item.name.original) and contains_cjk(item.name.translated):
        logging.warning("ğŸ”„ æª¢æ¸¬åˆ°æ¬„ä½é¡›å€’ï¼Œäº¤æ› original å’Œ translated")
        item.name.original, item.name.translated = item.name.translated, item.name.original
    
    # ä¸­æ–‡è¨‚å–®é …ç›®ï¼ˆä½¿ç”¨åŸå§‹ä¸­æ–‡èœåï¼‰
    zh_items.append({
        'name': item.name.original,
        'quantity': item.quantity,
        'price': item.price,
        'subtotal': subtotal
    })
```

## ğŸ¨ å‰ç«¯ä¿®å¾© (liff-web)

### 1. æ›´æ–°èœåé¡¯ç¤ºé‚è¼¯

**æª”æ¡ˆ**: `../liff-web/index.html`

**ä¿®æ”¹å‰**:
```javascript
// æ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±
const texts = translations[currentLanguage] || translations['zh-TW'];
const itemName = safeStr(item.translated_name || item.original_name || item.item_name || 'Untitled');
```

**ä¿®æ”¹å¾Œ**:
```javascript
// æ”¯æ´å¤šç¨®å¯èƒ½çš„æ¬„ä½åç¨±ï¼ˆåŒ…æ‹¬æ–°çš„é›™èªæ ¼å¼ï¼‰
const texts = translations[currentLanguage] || translations['zh-TW'];

// æ”¯æ´æ–°çš„é›™èªæ ¼å¼ {name: {original: "ä¸­æ–‡", translated: "English"}}
let itemName;
if (item.name && typeof item.name === 'object' && item.name.original && item.name.translated) {
    // æ–°æ ¼å¼ï¼šæ ¹æ“šä½¿ç”¨è€…èªè¨€é¸æ“‡èœå
    if (currentLanguage.startsWith('zh')) {
        itemName = item.name.original; // ä¸­æ–‡ä½¿ç”¨è€…ä½¿ç”¨ä¸­æ–‡èœå
    } else {
        itemName = item.name.translated; // å…¶ä»–èªè¨€ä½¿ç”¨è€…ä½¿ç”¨ç¿»è­¯èœå
    }
} else {
    // èˆŠæ ¼å¼ï¼šå„ªå…ˆä½¿ç”¨ translated_nameï¼Œç„¶å¾Œæ˜¯ original_name
    itemName = safeStr(item.translated_name || item.original_name || item.item_name || 'Untitled');
}
```

### 2. æ›´æ–°è¨‚å–®æäº¤æ ¼å¼

**æª”æ¡ˆ**: `../liff-web/index.html`

**ä¿®æ”¹å‰**:
```javascript
return {
    // æ”¯æ´å¤šç¨® ID æ ¼å¼
    menu_item_id: item.menu_item_id || item.id || item.temp_id,
    // æ”¯æ´å¤šç¨®æ•¸é‡æ¬„ä½åç¨±
    quantity: quantity,  // å¾Œç«¯ä¹Ÿæ”¯æ´ qty
    qty: quantity,      // å¾Œç«¯ä¹Ÿæ”¯æ´ quantity
    // æ”¯æ´å¤šç¨®åƒ¹æ ¼æ¬„ä½åç¨±
    price_unit: priceUnit,  // å¾Œç«¯ä¹Ÿæ”¯æ´ price æˆ– price_small
    price: priceUnit,       // å¾Œç«¯ä¹Ÿæ”¯æ´ price_unit
    // é¡å¤–è³‡è¨Šï¼ˆå¯é¸ï¼‰
    item_name: item.translated_name || item.original_name || item.item_name,
    subtotal: itemTotal
};
```

**ä¿®æ”¹å¾Œ**:
```javascript
return {
    // æ”¯æ´å¤šç¨® ID æ ¼å¼
    menu_item_id: item.menu_item_id || item.id || item.temp_id,
    // æ”¯æ´å¤šç¨®æ•¸é‡æ¬„ä½åç¨±
    quantity: quantity,  // å¾Œç«¯ä¹Ÿæ”¯æ´ qty
    qty: quantity,      // å¾Œç«¯ä¹Ÿæ”¯æ´ quantity
    // æ”¯æ´å¤šç¨®åƒ¹æ ¼æ¬„ä½åç¨±
    price_unit: priceUnit,  // å¾Œç«¯ä¹Ÿæ”¯æ´ price æˆ– price_small
    price: priceUnit,       // å¾Œç«¯ä¹Ÿæ”¯æ´ price_unit
    // æ”¯æ´æ–°çš„é›™èªæ ¼å¼
    name: item.name && typeof item.name === 'object' ? item.name : {
        original: item.original_name || item.item_name || 'Untitled',
        translated: item.translated_name || item.item_name || 'Untitled'
    },
    // é¡å¤–è³‡è¨Šï¼ˆå¯é¸ï¼‰
    item_name: item.translated_name || item.original_name || item.item_name,
    subtotal: itemTotal
};
```

### 3. æ›´æ–°è¨‚å–®ç¢ºèªé¡¯ç¤º

**æª”æ¡ˆ**: `../liff-web/index.html`

**ä¿®æ”¹å‰**:
```javascript
const itemName = menuItem.translated_name || menuItem.original_name || menuItem.item_name || 'Untitled';
```

**ä¿®æ”¹å¾Œ**:
```javascript
// æ”¯æ´æ–°çš„é›™èªæ ¼å¼
let itemName;
if (menuItem.name && typeof menuItem.name === 'object' && menuItem.name.original && menuItem.name.translated) {
    // æ–°æ ¼å¼ï¼šæ ¹æ“šä½¿ç”¨è€…èªè¨€é¸æ“‡èœå
    if (currentLanguage.startsWith('zh')) {
        itemName = menuItem.name.original; // ä¸­æ–‡ä½¿ç”¨è€…ä½¿ç”¨ä¸­æ–‡èœå
    } else {
        itemName = menuItem.name.translated; // å…¶ä»–èªè¨€ä½¿ç”¨è€…ä½¿ç”¨ç¿»è­¯èœå
    }
} else {
    // èˆŠæ ¼å¼ï¼šå„ªå…ˆä½¿ç”¨ translated_nameï¼Œç„¶å¾Œæ˜¯ original_name
    itemName = menuItem.translated_name || menuItem.original_name || menuItem.item_name || 'Untitled';
}
```

## ğŸ“Š ä¿®å¾©æ•ˆæœå°æ¯”

### ä¿®å¾©å‰
```javascript
// å•é¡Œï¼šoriginal è¢«è‹±æ–‡è¦†è“‹
{
    name: {
        original: "Honey Tea",  // âŒ è‹±æ–‡
        translated: "Honey Tea"  // âŒ è‹±æ–‡
    }
}

// çµæœï¼šä¸­æ–‡æ‘˜è¦é¡¯ç¤ºè‹±æ–‡
zh_summary: "Honey Tea x 1ã€Alcoholic Coffee x 1"
```

### ä¿®å¾©å¾Œ
```javascript
// ä¿®å¾©ï¼šæ­£ç¢ºä½¿ç”¨ä¸­æ–‡ä½œç‚º original
{
    name: {
        original: "èœ‚èœœèŒ¶",        // âœ… ä¸­æ–‡
        translated: "Honey Tea"   // âœ… è‹±æ–‡
    }
}

// çµæœï¼šä¸­æ–‡æ‘˜è¦é¡¯ç¤ºä¸­æ–‡
zh_summary: "èœ‚èœœèŒ¶ x 1ã€é…’ç²¾å’–å•¡ x 1"
```

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### 1. ä¸­æ–‡æª¢æ¸¬æ¸¬è©¦
```python
# æ¸¬è©¦ contains_cjk å‡½æ•¸
test_cases = [
    ("Honey Tea", False),
    ("èœ‚èœœèŒ¶", True),
    ("ç¶“å…¸å¤å¨å¤·å¥¶é†¬ç¾©å¤§åˆ©éºµ", True),
    ("Creamy Classic Hawaiian", False),
    ("é…’ç²¾å’–å•¡", True),
    ("Alcoholic Coffee", False),
]
```

### 2. æœ¬åœ°åŒ–èœåæ¸¬è©¦
```python
# æ¸¬è©¦ safe_build_localised_name å‡½æ•¸
test_cases = [
    ("Honey Tea", "èœ‚èœœèŒ¶", "èœ‚èœœèŒ¶", "Honey Tea"),
    ("Creamy Classic Hawaiian", "ç¶“å…¸å¤å¨å¤·å¥¶é†¬ç¾©å¤§åˆ©éºµ", "ç¶“å…¸å¤å¨å¤·å¥¶é†¬ç¾©å¤§åˆ©éºµ", "Creamy Classic Hawaiian"),
    ("Honey Tea", None, "Honey Tea", "Honey Tea"),
    ("èœ‚èœœèŒ¶", None, "èœ‚èœœèŒ¶", "èœ‚èœœèŒ¶"),
]
```

### 3. æ¬„ä½ä¿è­·æ¸¬è©¦
```python
# æ¸¬è©¦æ¬„ä½é¡›å€’æª¢æ¸¬
field_scenarios = [
    {
        "original": "Honey Tea",
        "translated": "èœ‚èœœèŒ¶",
        "should_swap": True
    },
    {
        "original": "èœ‚èœœèŒ¶",
        "translated": "Honey Tea",
        "should_swap": False
    }
]
```

## ğŸ“ˆ ä¿®å¾©çµ±è¨ˆ

### å¾Œç«¯ä¿®æ”¹
- **ä¿®æ”¹æª”æ¡ˆ**: 2 å€‹
- **æ–°å¢è¡Œæ•¸**: 608 è¡Œ
- **æ–°å¢å‡½æ•¸**: 2 å€‹
- **ä¿®æ”¹å‡½æ•¸**: 2 å€‹

### å‰ç«¯ä¿®æ”¹
- **ä¿®æ”¹æª”æ¡ˆ**: 1 å€‹
- **æ–°å¢è¡Œæ•¸**: 33 è¡Œ
- **ä¿®æ”¹å‡½æ•¸**: 3 å€‹

## âœ… é©—è­‰çµæœ

### 1. å–®å…ƒæ¸¬è©¦
- âœ… ä¸­æ–‡æª¢æ¸¬å‡½æ•¸æ¸¬è©¦é€šé
- âœ… æœ¬åœ°åŒ–èœåå»ºç«‹å‡½æ•¸æ¸¬è©¦é€šé
- âœ… è¨‚å–®å ´æ™¯æ¸¬è©¦é€šé
- âœ… æ¬„ä½ä¿è­·é‚è¼¯æ¸¬è©¦é€šé

### 2. å¯¦éš›è¨‚å–®æ¸¬è©¦
- âœ… éåˆä½œåº—å®¶ï¼ŒOCR æˆåŠŸå–å¾—ä¸­æ–‡
- âœ… æ¬„ä½é¡›å€’çš„æƒ…æ³
- âœ… èˆŠæ ¼å¼è½‰æ›

### 3. èªè¨€æ”¯æ´
- âœ… ä¸­æ–‡ä½¿ç”¨è€…ï¼šé¡¯ç¤ºä¸­æ–‡èœå
- âœ… è‹±æ–‡ä½¿ç”¨è€…ï¼šé¡¯ç¤ºè‹±æ–‡èœå
- âœ… æ—¥æ–‡ä½¿ç”¨è€…ï¼šé¡¯ç¤ºè‹±æ–‡èœåï¼ˆå¦‚æœæ²’æœ‰æ—¥æ–‡ç¿»è­¯ï¼‰

## ğŸ¯ ç¸½çµ

é€šéé€™æ¬¡ä¿®å¾©ï¼Œæˆ‘å€‘æˆåŠŸè§£æ±ºäº†ï¼š

1. **ä¸­æ–‡æ‘˜è¦é¡¯ç¤ºè‹±æ–‡èœåå•é¡Œ**ï¼šé€šéå„ªå…ˆä½¿ç”¨ OCR ä¸­æ–‡èœå
2. **æ¬„ä½è¦†å¯«å•é¡Œ**ï¼šé€šéå®‰å…¨æœ¬åœ°åŒ–èœåå»ºç«‹å‡½æ•¸
3. **æ¬„ä½é¡›å€’å•é¡Œ**ï¼šé€šéæ™ºèƒ½æ¬„ä½ä¿è­·æ©Ÿåˆ¶
4. **å‰ç«¯ç›¸å®¹æ€§å•é¡Œ**ï¼šé€šéæ”¯æ´æ–°é›™èªæ ¼å¼

ç¾åœ¨ç³»çµ±å¯ä»¥ï¼š
- âœ… æ­£ç¢ºé¡¯ç¤ºä¸­æ–‡èœååœ¨æ‘˜è¦ä¸­
- âœ… ä½¿ç”¨ä¸­æ–‡èœåç”ŸæˆèªéŸ³
- âœ… è‡ªå‹•æª¢æ¸¬ä¸¦ä¿®æ­£æ¬„ä½é¡›å€’
- âœ… ä¿æŒå‘å¾Œç›¸å®¹æ€§
- âœ… æ”¯æ´å¤šèªè¨€åˆ‡æ›

æ‰€æœ‰ä¸­æ–‡èœåç›¸é—œå•é¡Œéƒ½å·²è§£æ±ºï¼ğŸ‰
