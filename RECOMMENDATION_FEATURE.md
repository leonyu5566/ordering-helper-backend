# 推薦店家功能說明

## 功能概述

推薦店家功能是 LINE Bot 的延伸功能，允許使用者提出餐飲需求，系統會使用 Gemini API 分析需求並推薦最適合的店家。

## 功能特色

### 1. 智能需求分析
- 自動識別使用者的餐飲需求
- 支援多種語言（中文、英文、日文、韓文）
- 理解複雜的飲食偏好和限制

### 2. AI 驅動推薦
- 使用 Gemini API 進行智能分析
- 考慮店家的特色菜色和評論
- 提供個性化的推薦理由

### 3. 優先級排序
按照以下順序推薦店家：
1. **VIP 店家** (partner_level=2) - 最高優先級
2. **合作店家** (partner_level=1) - 中等優先級
3. **非合作店家** (partner_level=0) - 最低優先級

## 使用流程

### 1. 觸發推薦功能
使用者可以通過以下方式觸發推薦功能：

#### 方式一：直接點擊按鈕
- 在 LINE Bot 主選單中點擊「推薦店家」按鈕

#### 方式二：自然語言描述
- 直接描述餐飲需求，例如：
  - "我想要吃辣的食物"
  - "我在找義大利料理"
  - "我需要素食選項"
  - "想要吃日本料理"
  - "想要吃甜點"

### 2. 需求分析
系統會自動分析使用者的需求，識別關鍵字和偏好。

### 3. AI 推薦
Gemini API 會根據以下因素進行推薦：
- 使用者需求與店家特色的匹配度
- 店家的合作等級
- 店家的熱門菜色
- 店家的評論摘要

### 4. 結果展示
推薦結果會包含：
- 店家名稱和合作等級
- 推薦理由
- 預估評分
- 後續操作提示

## 技術實現

### 1. 需求識別
```python
def is_food_request(text):
    """判斷是否為餐飲需求描述"""
    food_keywords = [
        "想吃", "想要", "推薦", "找", "尋找", "附近", "餐廳", "美食", 
        "料理", "菜", "飯", "麵", "火鍋", "燒烤", "壽司", "披薩", 
        "漢堡", "咖啡", "飲料", "甜點", "早餐", "午餐", "晚餐", "宵夜"
    ]
    return any(keyword in text for keyword in food_keywords)
```

### 2. AI 推薦引擎
```python
def get_ai_recommendations(food_request, user_language='zh'):
    """使用 Gemini API 分析餐飲需求並推薦店家"""
    # 建立 Gemini 提示詞
    prompt = f"""
你是一個專業的餐飲推薦專家。請根據使用者的餐飲需求，從以下店家列表中推薦最適合的店家。

## 使用者需求：
{food_request}

## 推薦規則：
1. **優先順序**：VIP店家 > 合作店家 > 非合作店家
2. **需求匹配**：根據使用者需求選擇最適合的店家
3. **菜色特色**：考慮店家的熱門菜色和評論摘要
4. **推薦數量**：最多推薦5家店家
"""
    # 調用 Gemini API 並解析結果
```

### 3. 結果排序
```python
# 按照合作等級排序
recommendations = sorted(
    result['recommendations'], 
    key=lambda x: x.get('partner_level', 0), 
    reverse=True
)
```

## 支援的語言

### 中文 (zh)
- 觸發關鍵字：推薦店家
- 需求描述：我想要吃辣的食物
- 推薦結果：🍽️ 根據您的需求，我為您推薦以下店家：

### 英文 (en)
- 觸發關鍵字：recommend restaurants
- 需求描述：I want spicy food
- 推薦結果：🍽️ Based on your request, I recommend the following restaurants:

### 日文 (ja)
- 觸發關鍵字：レストランを推薦
- 需求描述：辛い食べ物が欲しい
- 推薦結果：🍽️ ご要望に基づいて、以下のレストランをお勧めします：

### 韓文 (ko)
- 觸發關鍵字：레스토랑 추천
- 需求描述：매운 음식을 원해요
- 推薦結果：🍽️ 요청에 따라 다음 레스토랑을 추천합니다:

## 環境設定

### 必要的環境變數
```bash
# Gemini API 設定
GEMINI_API_KEY=your_gemini_api_key

# LINE Bot 設定
LINE_CHANNEL_ACCESS_TOKEN=your_line_channel_access_token
LINE_CHANNEL_SECRET=your_line_channel_secret
```

### 資料庫要求
店家資料表 (`stores`) 需要包含以下欄位：
- `store_id`: 店家唯一識別碼
- `store_name`: 店家名稱
- `partner_level`: 合作等級 (0=非合作, 1=合作, 2=VIP)
- `review_summary`: 評論摘要
- `top_dish_1` 到 `top_dish_5`: 熱門菜色
- `main_photo_url`: 店家照片

## 測試

### 運行測試
```bash
python test_recommendation.py
```

### 測試內容
1. **推薦功能邏輯測試**
   - 測試各種餐飲需求的識別
   - 驗證推薦結果的排序邏輯

2. **Gemini API 整合測試**
   - 驗證 API 金鑰設定
   - 測試 API 調用功能

3. **LINE Bot 整合測試**
   - 驗證 LINE Bot 環境變數
   - 測試訊息發送功能

4. **資料庫整合測試**
   - 驗證資料庫連接
   - 檢查店家資料結構

## 錯誤處理

### 常見錯誤及解決方案

1. **Gemini API 錯誤**
   - 檢查 API 金鑰是否正確設定
   - 確認 API 配額是否充足

2. **資料庫連接錯誤**
   - 檢查資料庫服務是否運行
   - 確認資料庫連接字串

3. **LINE Bot 錯誤**
   - 檢查 LINE Bot 設定是否正確
   - 確認 Webhook URL 設定

## 未來擴展

### 計劃中的功能
1. **個人化推薦**
   - 基於使用者歷史訂單的推薦
   - 學習使用者偏好

2. **位置感知推薦**
   - 結合使用者位置進行推薦
   - 考慮距離因素

3. **即時評分整合**
   - 整合即時評論系統
   - 動態更新推薦結果

4. **多媒體推薦**
   - 支援圖片和語音需求描述
   - 更豐富的推薦展示

## 維護注意事項

1. **定期更新關鍵字庫**
   - 根據使用者反饋更新需求識別關鍵字
   - 保持與時俱進的餐飲趨勢

2. **監控 API 使用量**
   - 定期檢查 Gemini API 使用情況
   - 優化 API 調用頻率

3. **資料庫維護**
   - 定期更新店家資料
   - 確保資料品質和準確性

4. **效能優化**
   - 監控推薦功能響應時間
   - 優化資料庫查詢效能 