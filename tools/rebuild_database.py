# =============================================================================
# æª”æ¡ˆåç¨±ï¼štools/rebuild_database.py
# åŠŸèƒ½æè¿°ï¼šè³‡æ–™åº«é‡å»ºå·¥å…·ï¼Œç”¨æ–¼å»ºç«‹æˆ–é‡æ–°å»ºç«‹æ‰€æœ‰è³‡æ–™åº«è¡¨æ ¼
# ä¸»è¦è·è²¬ï¼š
# - é€£æ¥åˆ°æŒ‡å®šçš„è³‡æ–™åº«
# - åˆªé™¤ç¾æœ‰çš„è¡¨æ ¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
# - æ ¹æ“š models.py å»ºç«‹æ–°çš„è¡¨æ ¼
# - é¡¯ç¤ºå»ºç«‹çµæœ
# ä½¿ç”¨æ™‚æ©Ÿï¼š
# - é¦–æ¬¡è¨­å®šè³‡æ–™åº«
# - è³‡æ–™åº«çµæ§‹è®Šæ›´
# - éœ€è¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™æ™‚
# æ³¨æ„ï¼šæ­¤æ“ä½œæœƒåˆªé™¤æ‰€æœ‰ç¾æœ‰è³‡æ–™ï¼
# =============================================================================

#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
é‡å»ºè³‡æ–™åº«è¡¨æ ¼çš„è…³æœ¬
é€™å€‹è…³æœ¬æœƒé€£æ¥åˆ°è³‡æ–™åº«ä¸¦æ ¹æ“š models.py ä¸­å®šç¾©çš„æ¨¡å‹å»ºç«‹æ‰€æœ‰è¡¨æ ¼
"""

import os
import sys
from dotenv import load_dotenv

# å°‡å°ˆæ¡ˆæ ¹ç›®éŒ„åŠ å…¥ Python è·¯å¾‘
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# è¼‰å…¥ç’°å¢ƒè®Šæ•¸
load_dotenv('notebook.env')

from app import create_app
from app.models import db

def rebuild_database():
    """é‡å»ºè³‡æ–™åº«è¡¨æ ¼"""
    print("é–‹å§‹é‡å»ºè³‡æ–™åº«è¡¨æ ¼...")
    
    # å»ºç«‹ Flask æ‡‰ç”¨ç¨‹å¼
    app = create_app()
    
    with app.app_context():
        try:
            # åˆªé™¤æ‰€æœ‰ç¾æœ‰è¡¨æ ¼
            print("åˆªé™¤ç¾æœ‰è¡¨æ ¼...")
            db.drop_all()
            
            # å»ºç«‹æ‰€æœ‰è¡¨æ ¼
            print("å»ºç«‹æ–°è¡¨æ ¼...")
            db.create_all()
            
            print("âœ… è³‡æ–™åº«è¡¨æ ¼é‡å»ºå®Œæˆï¼")
            
            # é¡¯ç¤ºå»ºç«‹çš„è¡¨æ ¼
            print("\nå»ºç«‹çš„è¡¨æ ¼ï¼š")
            for table_name in db.engine.table_names():
                print(f"  - {table_name}")
                
        except Exception as e:
            print(f"âŒ é‡å»ºè³‡æ–™åº«æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
            return False
    
    return True

if __name__ == '__main__':
    print("=== è³‡æ–™åº«é‡å»ºå·¥å…· ===")
    print("é€™å€‹å·¥å…·æœƒåˆªé™¤æ‰€æœ‰ç¾æœ‰è¡¨æ ¼ä¸¦é‡æ–°å»ºç«‹")
    print("è«‹ç¢ºä¿ä½ å·²ç¶“å‚™ä»½é‡è¦è³‡æ–™ï¼")
    print()
    
    # ç¢ºèªæ˜¯å¦è¦ç¹¼çºŒ
    response = input("æ˜¯å¦è¦ç¹¼çºŒé‡å»ºè³‡æ–™åº«ï¼Ÿ(y/N): ")
    if response.lower() != 'y':
        print("å–æ¶ˆé‡å»º")
        sys.exit(0)
    
    success = rebuild_database()
    if success:
        print("\nğŸ‰ è³‡æ–™åº«é‡å»ºæˆåŠŸï¼")
    else:
        print("\nğŸ’¥ è³‡æ–™åº«é‡å»ºå¤±æ•—ï¼")
        sys.exit(1) 