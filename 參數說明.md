# 菜單參數完整指南

## 📋 目錄
- [系統架構](#系統架構)
- [資料庫模型](#資料庫模型)
- [API 參數](#api-參數)
- [前端參數](#前端參數)
- [OCR 處理](#ocr-處理)
- [訂單系統](#訂單系統)
- [翻譯系統](#翻譯系統)
- [部署配置](#部署配置)
- [故障排除](#故障排除)

## 🏗️ 系統架構

### 整體架構
```
ordering-helper-backend/
├── app/
│   ├── api/           # API 路由
│   ├── models.py      # 資料庫模型
│   ├── helpers.py     # 輔助函數
│   └── webhook/       # LINE Bot 處理
├── .github/workflows/ # CI/CD 配置
├── templates/         # 前端模板
└── static/           # 靜態檔案
```

### 核心功能
- ✅ **菜單管理**：合作店家的菜單資料
- ✅ **OCR 處理**：非合作店家的菜單圖片辨識
- ✅ **多語言翻譯**：支援中文、英文、日文、韓文
- ✅ **訂單系統**：建立和管理訂單
- ✅ **語音生成**：Azure TTS 語音訂單
- ✅ **LINE Bot**：LINE 平台整合

## 🗄️ 資料庫模型

### Menu (菜單)
```python
class Menu(db.Model):
    __tablename__ = 'menus'
    menu_id = db.Column(db.BigInteger, primary_key=True)
    store_id = db.Column(db.Integer, db.ForeignKey('stores.store_id'), nullable=False)
    version = db.Column(db.Integer, nullable=False, default=1)
    created_at = db.Column(db.DateTime, default=datetime.datetime.utcnow)
    items = db.relationship('MenuItem', backref='menu', lazy=True, cascade="all, delete-orphan")
```

**參數說明**：
- `menu_id`：菜單唯一識別碼
- `store_id`：關聯的店家ID
- `version`：菜單版本號
- `created_at`：建立時間
- `items`：菜單項目關聯

### MenuItem (菜單項目)
```python
class MenuItem(db.Model):
    __tablename__ = 'menu_items'
    menu_item_id = db.Column(db.BigInteger, primary_key=True)
    menu_id = db.Column(db.BigInteger, db.ForeignKey('menus.menu_id'), nullable=False)
    item_name = db.Column(db.String(100), nullable=False)  # 中文菜品名
    price_big = db.Column(db.Integer)                      # 大份價格
    price_small = db.Column(db.Integer, nullable=False)    # 小份價格
    created_at = db.Column(db.DateTime, default=datetime.datetime.utcnow)
    translations = db.relationship('MenuTranslation', backref='menu_item', lazy=True, cascade="all, delete-orphan")
```

**參數說明**：
- `menu_item_id`：菜單項目唯一識別碼
- `menu_id`：關聯的菜單ID
- `item_name`：中文菜名
- `price_big`：大份價格（可選）
- `price_small`：小份價格（必填）
- `created_at`：建立時間
- `translations`：翻譯關聯

### MenuTranslation (菜單翻譯)
```python
class MenuTranslation(db.Model):
    __tablename__ = 'menu_translations'
    menu_translation_id = db.Column(db.BigInteger, primary_key=True)
    menu_item_id = db.Column(db.BigInteger, db.ForeignKey('menu_items.menu_item_id'), nullable=False)
    lang_code = db.Column(db.String(5), db.ForeignKey('languages.lang_code'), nullable=False)
    item_name_trans = db.Column(db.String(100))  # 翻譯後的菜品名
    description = db.Column(db.Text)             # 描述
    created_at = db.Column(db.DateTime, default=datetime.datetime.utcnow)
```

**參數說明**：
- `menu_translation_id`：翻譯記錄唯一識別碼
- `menu_item_id`：關聯的菜單項目ID
- `lang_code`：語言代碼（zh, en, ja, ko）
- `item_name_trans`：翻譯後的菜名
- `description`：描述文字
- `created_at`：建立時間

## 🔌 API 參數

### 取得菜單 API
**端點**：`GET /api/menu/{store_id}`

**查詢參數**：
```javascript
{
    lang: 'zh'  // 語言代碼：zh, en, ja, ko
}
```

**回應格式**：
```json
{
    "success": true,
    "store_id": 1,
    "user_language": "zh",
    "menu_items": [
        {
            "menu_item_id": 1,
            "original_name": "牛肉麵",
            "translated_name": "Beef Noodle Soup",
            "price_small": 100,
            "price_big": 150,
            "description": "美味牛肉麵",
            "translated_description": "Delicious beef noodle soup",
            "translation_source": "database"
        }
    ],
    "translation_stats": {
        "database_translations": 5,
        "ai_translations": 3
    },
    "total_items": 8
}
```

### 建立訂單 API
**端點**：`POST /api/orders`

**請求格式**：
```json
{
    "line_user_id": "user123",  // 可選，LINE 使用者 ID
    "store_id": 1,              // 必填，店家 ID
    "language": "zh",           // 可選，語言偏好
    "items": [
        {
            "menu_item_id": 1,
            "quantity": 2,
            "price_unit": 100
        }
    ]
}
```

**支援格式**：
```json
{
    "store_id": 1,              // 必填
    "items": [                  // 必填
        {
            "menu_item_id": 1,  // 或 "id"
            "quantity": 2,       // 或 "qty"
            "price_unit": 100    // 或 "price"
        }
    ]
}
```

**相容格式**（支援舊版）：
```json
{
    "line_user_id": "user123",
    "store_id": 1,
    "items": [
        {
            "id": 1,           // 舊格式
            "qty": 2,          // 舊格式
            "price": 100       // 舊格式
        }
    ]
}
```

**回應格式**：
```json
{
    "message": "訂單建立成功",
    "order_id": 12345,
    "order_details": [
        {
            "menu_item_id": 1,
            "item_name": "牛肉麵",
            "quantity": 2,
            "price": 100,
            "subtotal": 200
        }
    ],
    "total_amount": 200,
    "confirmation": {
        "chinese_voice_text": "您好，我要點餐。牛肉麵 2份，總共200元，謝謝。",
        "chinese_summary": "訂單編號：12345\n店家：牛肉麵店\n訂購項目：\n- 牛肉麵 x2 ($200)\n總金額：$200",
        "translated_summary": "Order #12345\nStore: Beef Noodle Shop\nItems:\n- Beef Noodle x2 ($200)\nTotal: $200"
    },
    "voice_generated": true
}
```

### 臨時訂單 API
**端點**：`POST /api/orders/temp`

**請求格式**：
```json
{
    "processing_id": 123,
    "items": [
        {
            "original_name": "牛肉麵",
            "translated_name": "Beef Noodle Soup",
            "quantity": 2,
            "price": 100,
            "temp_id": "temp_1"
        }
    ]
}
```

## 🖥️ 前端參數

### 購物車項目格式
```javascript
const cartItem = {
    menu_item_id: 1,        // 菜單項目ID
    item_name: "牛肉麵",     // 菜名
    price_small: 100,       // 小份價格
    price_big: 150,         // 大份價格（可選）
    quantity: 2,            // 數量
    subtotal: 200           // 小計
};
```

### 訂單提交格式
```javascript
const orderData = {
    line_user_id: "user123",
    store_id: 1,
    items: cartItems.map(item => ({
        menu_item_id: item.menu_item_id,
        quantity: item.quantity,
        price_unit: item.price_small
    })),
    total: cartItems.reduce((sum, item) => sum + item.subtotal, 0)
};
```

### 錯誤處理
```javascript
if (!response.ok) {
    const errorData = await response.json();
    
    if (errorData.validation_errors) {
        // 顯示詳細的驗證錯誤
        const errorMessage = errorData.validation_errors.join('\n');
        alert(`訂單資料驗證失敗：\n${errorMessage}`);
    } else if (errorData.missing_fields) {
        // 顯示缺少的欄位
        const missingFields = errorData.missing_fields.join(', ');
        alert(`缺少必要欄位：${missingFields}`);
    } else {
        // 一般錯誤
        alert(`訂單建立失敗：${errorData.error}`);
    }
    return;
}
```

## 🔍 OCR 處理

### Gemini API 處理
**函數**：`process_menu_with_gemini(image_path, target_language)`

**輸入參數**：
- `image_path`：圖片檔案路徑
- `target_language`：目標語言（預設：'en'）

**回應格式**：
```json
{
    "success": true,
    "menu_items": [
        {
            "original_name": "牛肉麵",
            "translated_name": "Beef Noodle Soup",
            "price": 100,
            "description": "美味牛肉麵",
            "category": "麵食"
        }
    ],
    "store_info": {
        "name": "牛肉麵店",
        "address": "台北市信義區",
        "phone": "02-1234-5678"
    },
    "processing_notes": "成功辨識到 8 個菜單項目"
}
```

### 動態菜單格式
```json
{
    "menu_items": [
        {
            "temp_id": "temp_1",
            "original_name": "牛肉麵",
            "translated_name": "Beef Noodle Soup",
            "price_small": 100,
            "price_big": 150,
            "description": "美味牛肉麵",
            "category": "麵食"
        }
    ],
    "total_items": 8,
    "processing_id": 123
}
```

## 🛒 訂單系統

### Order (訂單)
```python
class Order(db.Model):
    __tablename__ = 'orders'
    order_id = db.Column(db.BigInteger, primary_key=True)
    user_id = db.Column(db.BigInteger, db.ForeignKey('users.user_id'), nullable=False)
    store_id = db.Column(db.Integer, db.ForeignKey('stores.store_id'), nullable=False)
    order_time = db.Column(db.DateTime, default=datetime.datetime.utcnow)
    total_amount = db.Column(db.Integer, nullable=False, default=0)
    status = db.Column(db.String(20), default='pending')  # pending, completed, cancelled
    items = db.relationship('OrderItem', backref='order', lazy=True, cascade="all, delete-orphan")
    voice_files = db.relationship('VoiceFile', backref='order', lazy=True, cascade="all, delete-orphan")
```

### OrderItem (訂單項目)
```python
class OrderItem(db.Model):
    __tablename__ = 'order_items'
    order_item_id = db.Column(db.BigInteger, primary_key=True)
    order_id = db.Column(db.BigInteger, db.ForeignKey('orders.order_id'), nullable=False)
    menu_item_id = db.Column(db.BigInteger, db.ForeignKey('menu_items.menu_item_id'), nullable=False)
    quantity_small = db.Column(db.Integer, nullable=False, default=0)
    subtotal = db.Column(db.Integer, nullable=False)
```

## 🌐 翻譯系統

### 支援語言
- `zh`：中文（繁體）
- `en`：英文
- `ja`：日文
- `ko`：韓文

### 翻譯優先順序
1. **資料庫翻譯**：優先使用已儲存的翻譯
2. **AI 翻譯**：如果資料庫沒有，使用 Gemini API 翻譯
3. **原文**：如果翻譯失敗，使用原文

### 翻譯函數
```python
def translate_menu_items_with_db_fallback(menu_items, target_language='en'):
    """
    翻譯菜單項目（優先使用資料庫翻譯）
    """
    translated_items = []
    
    for item in menu_items:
        # 先嘗試從資料庫取得翻譯
        db_translation = get_menu_translation_from_db(item.menu_item_id, target_language)
        
        if db_translation and db_translation.item_name_trans:
            # 使用資料庫翻譯
            translated_name = db_translation.item_name_trans
            translated_description = db_translation.description
        else:
            # 使用AI翻譯
            translated_name = translate_text_with_fallback(item.item_name, target_language)
            translated_description = translate_text_with_fallback(item.description, target_language) if item.description else None
        
        translated_item = {
            'menu_item_id': item.menu_item_id,
            'original_name': str(item.item_name or ''),
            'translated_name': str(translated_name or ''),
            'description': str(item.description or ''),
            'translated_description': str(translated_description or ''),
            'translation_source': 'database' if db_translation and db_translation.item_name_trans else 'ai'
        }
        translated_items.append(translated_item)
    
    return translated_items
```

## 🚀 部署配置

### GitHub Actions 配置
```yaml
name: Deploy to Cloud Run

on:
  push:
    branches: [main, master]

env:
  PROJECT_ID: solid-heaven-466011-d1
  PROJECT_NUMBER: 1095766716155
  SERVICE_NAME: ordering-helper-backend
  REGION: asia-east1

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-cloudrun
      cancel-in-progress: true
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github/providers/default
        service_account: github-ci@${{ env.PROJECT_ID }}.iam.gserviceaccount.com
    
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Build and Push Container
      run: |
        docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/ordering-helper-backend/${{ env.SERVICE_NAME }}:${{ github.sha }} .
        docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/ordering-helper-backend/${{ env.SERVICE_NAME }}:${{ github.sha }}
    
    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v2
      with:
        service: ${{ env.SERVICE_NAME }}
        image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/ordering-helper-backend/${{ env.SERVICE_NAME }}:${{ github.sha }}
        region: ${{ env.REGION }}
        env_vars: |
          DB_USER=${{ secrets.DB_USER }}
DB_PASSWORD=${{ secrets.DB_PASSWORD }}
DB_HOST=${{ secrets.DB_HOST }}
DB_DATABASE=${{ secrets.DB_DATABASE }}
          LINE_CHANNEL_ACCESS_TOKEN=${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_CHANNEL_SECRET=${{ secrets.LINE_CHANNEL_SECRET }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          AZURE_SPEECH_KEY=${{ secrets.AZURE_SPEECH_KEY }}
          AZURE_SPEECH_REGION=${{ secrets.AZURE_SPEECH_REGION }}
```

### Docker 配置
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

ENV FLASK_APP=run.py
ENV FLASK_ENV=production

EXPOSE 8080

CMD ["gunicorn", "--bind", "0.0.0.0:8080", "--workers", "1", "--timeout", "120", "--graceful-timeout", "30", "--max-requests", "1000", "--max-requests-jitter", "100", "run:app"]
```

## 🔧 故障排除

### 常見問題

#### 1. 訂單建立失敗 (400 錯誤)
**原因**：參數格式不正確或缺少必要欄位
**解決方案**：
```javascript
// 確保使用正確的參數名稱
const orderData = {
    line_user_id: "user123",  // 可選，LINE 使用者 ID
    store_id: 1,              // 必填
    language: "zh",           // 可選
    items: [
        {
            menu_item_id: 1,  // 或 id
            quantity: 2,       // 或 qty
            price_unit: 100    // 或 price
        }
    ]
};

// 非 LINE 入口可以省略 line_user_id
const guestOrderData = {
    store_id: 1,
    items: [
        {
            menu_item_id: 1,
            quantity: 2,
            price_unit: 100
        }
    ]
};
```

#### 2. 菜單項目找不到
**原因**：menu_item_id 不存在
**解決方案**：
```bash
# 檢查菜單項目是否存在
curl -X GET "https://your-api-url/api/menu/1?lang=zh"
```

#### 3. 翻譯失敗
**原因**：API 金鑰或網路問題
**解決方案**：
```bash
# 檢查環境變數
echo $GEMINI_API_KEY
echo $AZURE_SPEECH_KEY
```

#### 4. 部署失敗
**原因**：版本衝突
**解決方案**：
```bash
# 重新運行部署
# 在 GitHub Actions 頁面點擊 "Re-run jobs"
```

### 除錯工具

#### 1. 除錯端點
```bash
curl -X POST https://your-api-url/api/debug/order-data \
  -H "Content-Type: application/json" \
  -d '{
    "line_user_id": "test_user",
    "store_id": 1,
    "items": [
      {
        "id": 1,
        "qty": 2,
        "price": 100
      }
    ]
  }'
```

#### 2. 測試腳本
```bash
python test_order_api.py
```

#### 3. 日誌檢查
```bash
# Cloud Run 日誌
gcloud run services logs read ordering-helper-backend --region=asia-east1

# 本地日誌
tail -f logs/app.log
```

## 📊 參數對照表

| **用途** | **標準參數名** | **相容參數名** | **資料庫欄位** | **說明** |
|---------|---------------|---------------|---------------|----------|
| 菜單項目ID | `menu_item_id` | `id` | `menu_item_id` | 菜單項目的唯一識別碼 |
| 數量 | `quantity` | `qty` | `quantity_small` | 訂購數量 |
| 價格 | `price_unit` | `price`, `price_small` | `price_small` | 單價 |
| 菜名 | `item_name` | `original_name`, `name` | `item_name` | 中文菜名 |
| 翻譯菜名 | `translated_name` | `item_name_trans` | `item_name_trans` | 翻譯後的菜名 |
| 大份價格 | `price_big` | - | `price_big` | 大份價格 |
| 小份價格 | `price_small` | `price` | `price_small` | 小份價格 |
| 描述 | `description` | - | `description` | 菜單項目描述 |
| 分類 | `category` | - | - | 菜單項目分類 |

## 📝 更新日誌

- **2024-01-XX**：建立完整的菜單參數指南
- **2024-01-XX**：添加 API 參數說明
- **2024-01-XX**：完善故障排除指南
- **2024-01-XX**：添加部署配置說明

## 🤝 貢獻指南

1. **遵循參數命名規範**
2. **保持向後相容性**
3. **添加適當的錯誤處理**
4. **更新相關文檔**

## 📞 支援

如有問題，請：
1. 查看故障排除指南
2. 使用除錯端點檢查資料格式
3. 檢查 GitHub Issues
4. 聯繫開發團隊 