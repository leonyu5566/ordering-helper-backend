# 點餐傳聲筒 - 完整功能說明書

## 系統概述

點餐傳聲筒是一個專為外國旅客設計的智慧點餐系統，透過 LINE Bot 和 LIFF 網頁應用程式，提供多語言支援的點餐服務。系統支援合作店家和非合作店家兩種模式，並整合了 AI 語音生成功能。

## 核心功能架構

### 1. 多語言支援系統

#### 1.1 支援語言
- **中文 (zh)**：繁體中文
- **英文 (en)**：English
- **日文 (ja)**：日本語
- **韓文 (ko)**：한국어

#### 1.2 語言管理
- `Language` 模型：管理系統支援的語言
- `User.preferred_lang`：儲存使用者語言偏好
- 自動語言檢測和切換

### 2. 使用者管理系統

#### 2.1 使用者模型 (`User`)
```sql
users 表結構：
- user_id (BigInteger, PK)：使用者唯一識別碼
- line_user_id (String, 100)：LINE 平台使用者 ID
- preferred_lang (String, 5)：使用者偏好語言
- created_at (DateTime)：帳號建立時間
```

#### 2.2 功能特色
- 自動建立使用者帳號
- 語言偏好設定
- LINE Bot 整合
- 訪客模式支援

### 3. 店家管理系統

#### 3.1 店家模型 (`Store`)
```sql
stores 表結構：
- store_id (Integer, PK)：店家唯一識別碼
- store_name (String, 100)：店家名稱
- partner_level (SmallInteger)：合作等級 (0=非合作, 1=合作, 2=VIP)
- gps_lat/gps_lng (Float)：GPS 座標
- place_id (String, 100)：Google Places ID
- review_summary (Text)：評論摘要
- top_dish_1-5 (String, 100)：熱門菜色
- main_photo_url (String, 255)：店家招牌照片
- created_at (DateTime)：建立時間
```

#### 3.2 店家翻譯 (`StoreTranslation`)
```sql
store_translations 表結構：
- id (Integer, PK)：翻譯記錄 ID
- store_id (Integer, FK)：店家 ID
- language_code (String, 5)：語言代碼
- description (Text)：翻譯後的店家簡介
- translated_summary (Text)：翻譯後的評論摘要
```

#### 3.3 合作等級分類
- **VIP 店家 (partner_level=2)**：最高等級合作店家
- **合作店家 (partner_level=1)**：一般合作店家
- **非合作店家 (partner_level=0)**：支援拍照辨識的店家

### 4. 菜單管理系統

#### 4.1 菜單模型 (`Menu`)
```sql
menus 表結構：
- menu_id (BigInteger, PK)：菜單唯一識別碼
- store_id (Integer, FK)：店家 ID
- version (Integer)：菜單版本號
- created_at (DateTime)：建立時間
```

#### 4.2 菜單項目 (`MenuItem`)
```sql
menu_items 表結構：
- menu_item_id (BigInteger, PK)：菜單項目 ID
- menu_id (BigInteger, FK)：菜單 ID
- item_name (String, 100)：中文菜品名稱
- price_big (Integer)：大份量價格
- price_small (Integer)：小份量價格
- created_at (DateTime)：建立時間
```

#### 4.3 菜單翻譯 (`MenuTranslation`)
```sql
menu_translations 表結構：
- menu_translation_id (BigInteger, PK)：翻譯記錄 ID
- menu_item_id (BigInteger, FK)：菜單項目 ID
- lang_code (String, 5)：語言代碼
- item_name_trans (String, 100)：翻譯後的菜品名稱
- description (Text)：菜品描述
- created_at (DateTime)：建立時間
```

### 5. 訂單管理系統

#### 5.1 訂單模型 (`Order`)
```sql
orders 表結構：
- order_id (BigInteger, PK)：訂單唯一識別碼
- user_id (BigInteger, FK)：使用者 ID
- store_id (Integer, FK)：店家 ID
- order_time (DateTime)：訂單時間
- total_amount (Integer)：總金額
- status (String, 20)：訂單狀態 (pending, completed, cancelled)
```

#### 5.2 訂單項目 (`OrderItem`)
```sql
order_items 表結構：
- order_item_id (BigInteger, PK)：訂單項目 ID
- order_id (BigInteger, FK)：訂單 ID
- menu_item_id (BigInteger, FK)：菜單項目 ID
- quantity_small (Integer)：小份量數量
- subtotal (Integer)：小計金額
```

### 6. 語音檔案管理

#### 6.1 語音檔案模型 (`VoiceFile`)
```sql
voice_files 表結構：
- voice_file_id (BigInteger, PK)：語音檔案 ID
- order_id (BigInteger, FK)：訂單 ID
- file_url (String, 500)：語音檔案 URL
- file_type (String, 10)：檔案類型 (mp3, wav)
- speech_rate (Float)：語速倍率
- created_at (DateTime)：建立時間
```

### 7. OCR 處理系統（非合作店家）

#### 7.1 OCR 菜單 (`OCRMenu`)
```sql
ocr_menus 表結構：
- ocr_menu_id (BigInteger, PK)：OCR 菜單 ID
- user_id (BigInteger, FK)：使用者 ID
- store_name (String, 100)：非合作店家名稱
- upload_time (DateTime)：上傳時間
```

#### 7.2 OCR 菜單項目 (`OCRMenuItem`)
```sql
ocr_menu_items 表結構：
- ocr_menu_item_id (BigInteger, PK)：OCR 菜單項目 ID
- ocr_menu_id (BigInteger, FK)：OCR 菜單 ID
- item_name (String, 100)：品項名稱
- price_big (Integer)：大份量價格
- price_small (Integer)：小份量價格
- translated_desc (Text)：翻譯後介紹
```

## 使用流程

### 1. 合作店家流程

#### 1.1 使用者加入
1. 旅客掃描 QR Code 加入 LINE Bot
2. Bot 引導使用者選擇介面語言
3. 系統自動建立使用者帳號

#### 1.2 店家探索
1. 透過 GPS 取得使用者位置
2. 列出鄰近店家清單並附招牌照片
3. 顯示翻譯後的店家簡介與評論
4. 標示合作店家等級（VIP／合作）

#### 1.3 點餐流程
1. 使用者在 LINE Bot 點選店家
2. 跳轉至專屬 LIFF 頁面
3. 從資料庫撈取已結構化菜單
4. 依使用者語言顯示菜單
5. 使用者選擇品項與數量
6. 點擊「確認訂單」顯示訂單明細

#### 1.4 語音生成
1. 後端接收訂單後生成中文語音
2. 呼叫 Azure TTS API 合成語音
3. 生成自然的中文語音檔
4. 支援語速調整（0.5x - 2.0x）

#### 1.5 LINE Bot 回傳
1. 發送兩則訂單文字摘要：
   - 使用者語言摘要（英文/日文/韓文）
   - 中文摘要（供現場點餐使用）
2. 發送中文語音檔
3. 提供語速控制按鈕

#### 1.6 現場點餐
1. 使用者於店家櫃檯播放中文語音
2. 語音內容包含完整的點餐資訊
3. 支援不同語速播放
4. 可重複播放確保點餐準確性

### 2. 非合作店家流程

#### 2.1 店家選擇
1. 使用者在 LINE Bot 選擇非合作店家
2. 跳轉至 LIFF 拍照介面
3. 提示使用者拍攝紙本菜單

#### 2.2 菜單辨識
1. 使用者上傳菜單照片
2. 後端呼叫 Gemini API 進行 OCR
3. 辨識菜單文字和價格
4. 將菜單項目轉成結構化資料

#### 2.3 翻譯處理
1. 使用 Gemini API 翻譯菜單項目
2. 翻譯為使用者選擇的語言
3. 動態生成可點選菜單介面

#### 2.4 點餐流程
1. 使用者在 LIFF 介面選擇品項與數量
2. 即時計算小計和總金額
3. 支援數量調整和移除商品
4. 點擊「確認訂單」顯示完整訂單明細

#### 2.5 語音生成
1. 後端將品項轉回原始中文菜名
2. 生成自然的中文語音內容
3. 呼叫 Azure TTS API 合成語音
4. 提供可調語速版本

#### 2.6 LINE Bot 回傳
1. 發送訂單文字摘要（使用者語言）
2. 發送中文語音檔
3. 提供語速控制按鈕

## 技術特色

### 1. 多語言支援
- 優先使用資料庫翻譯
- AI 翻譯作為備用方案
- 支援中文、英文、日文、韓文
- 自動語言檢測和切換

### 2. 智慧菜單處理
- 使用 Gemini API 進行 OCR
- 自動結構化菜單資料
- 即時翻譯成使用者語言
- 支援複雜菜單格式

### 3. 自然語音生成
- 使用 Azure TTS API
- 生成自然的中文語音
- 支援語速調整
- 多種語音選擇

### 4. 完整的訂單系統
- 合作店家：完整資料庫儲存
- 非合作店家：即時處理
- 多語言訂單摘要
- 語音訂單確認

### 5. 錯誤處理和用戶體驗
- 完整的錯誤訊息
- 多語言支援
- 友善的使用者介面
- 自動重試機制

## API 端點

### 核心 API

#### 店家相關
- `GET /api/stores/{store_id}` - 取得店家資訊（支援多語言）
- `GET /api/stores/check-partner-status` - 檢查店家合作狀態
- `GET /api/stores` - 取得所有店家列表

#### 菜單相關
- `GET /api/menu/{store_id}` - 取得合作店家菜單（支援多語言）
- `POST /api/menu/process-ocr` - 處理非合作店家菜單圖片
- `POST /api/upload-menu-image` - 上傳菜單圖片

#### 訂單相關
- `POST /api/orders` - 建立訂單（合作店家）
- `POST /api/orders/simple` - 建立簡化訂單（非合作店家）
- `GET /api/orders/{order_id}/confirm` - 取得訂單確認資訊
- `GET /api/orders/{order_id}/voice` - 取得訂單語音檔

#### 語音相關
- `POST /api/voice/generate` - 生成自定義語音檔

#### 使用者相關
- `POST /api/users/register` - 使用者註冊

### LINE Bot 功能

#### 語音控制指令
- `voice_slow_{order_id}` - 慢速播放 (0.7x)
- `voice_normal_{order_id}` - 正常播放 (1.0x)
- `voice_fast_{order_id}` - 快速播放 (1.3x)
- `voice_replay_{order_id}` - 重新播放

#### 臨時訂單語音控制
- `temp_voice_slow_{processing_id}` - 臨時訂單慢速播放
- `temp_voice_normal_{processing_id}` - 臨時訂單正常播放
- `temp_voice_fast_{processing_id}` - 臨時訂單快速播放
- `temp_voice_replay_{processing_id}` - 臨時訂單重新播放

## 部署需求

### 環境需求
- Python 3.8+
- Flask
- SQLAlchemy
- LINE Bot SDK
- Google Gemini API
- Azure Speech Service

### 環境變數
```bash
# Gemini API
GEMINI_API_KEY=your_gemini_api_key

# Azure Speech Service
AZURE_SPEECH_KEY=your_azure_speech_key
AZURE_SPEECH_REGION=your_azure_region

# LINE Bot
LINE_CHANNEL_ACCESS_TOKEN=your_line_channel_access_token
LINE_CHANNEL_SECRET=your_line_channel_secret

# 資料庫
DATABASE_URL=your_database_url
```

## 開發原則

### 1. 職責分離
- LINE Bot 負責使用者互動和位置服務
- 後端專注於資料處理和 AI 功能
- LIFF 前端獨立部署

### 2. 簡化架構
- 移除不必要的 GPS 定位功能
- 專注於核心的菜單翻譯和訂單處理

### 3. 效能優化
- 優先使用資料庫翻譯減少 API 呼叫
- 快取常用的翻譯結果

### 4. 使用者體驗
- 完整的錯誤處理和重試機制
- 多語言支援
- 直觀的介面設計

## 未來發展

### 1. 功能擴展
- 支援更多語言
- 增加更多語音選項
- 支援更複雜的菜單格式

### 2. 效能優化
- 實作快取機制
- 優化資料庫查詢
- 改善語音生成速度

### 3. 使用者體驗
- 改善介面設計
- 增加更多互動功能
- 提供更詳細的使用統計

---

*最後更新：2025年8月6日* 