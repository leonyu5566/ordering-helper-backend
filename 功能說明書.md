# 點餐小幫手後端功能說明書

## 專案概述

點餐小幫手後端是一個基於 Flask 的 LINE Bot 服務，提供智能點餐、多語言支援、AI 推薦等功能。本說明書詳細列出所有功能及其對應的程式碼檔案。

## 核心架構

```
ordering-helper-backend/
├── app/                    # 主要應用程式目錄
│   ├── __init__.py        # Flask 應用程式初始化
│   ├── models.py          # 資料庫模型定義
│   ├── errors.py          # 錯誤處理和日誌系統
│   ├── prompts.py         # AI 提示詞工程
│   ├── langchain_enhancement.py  # LangChain 強化模組 ⭐ **新增**
│   ├── ai_enhancement.py  # AI 強化整合模組 ⭐ **新增**
│   ├── api/               # API 端點模組
│   ├── webhook/           # LINE Bot Webhook 處理
│   └── admin/             # 管理後台
├── templates/             # HTML 模板
├── static/               # 靜態檔案
├── tools/                # 工具腳本
├── test_langchain_enhancement.py  # LangChain 測試腳本 ⭐ **新增**
└── LANGCHAIN_ENHANCEMENT_GUIDE.md  # LangChain 說明文件 ⭐ **新增**
```

## 功能模組詳細說明

### 1. 應用程式初始化 (`app/__init__.py`)

**功能描述：**
- Flask 應用程式建立和配置
- 資料庫連線設定
- Blueprint 註冊
- 錯誤處理器註冊

**主要功能：**
- ✅ 建立 Flask 應用程式實例
- ✅ 設定 SQLAlchemy 資料庫連線
- ✅ 註冊所有 Blueprint（admin、api、webhook）
- ✅ 設定錯誤處理和日誌系統
- ✅ 提供測試頁面端點

**相關檔案：**
- `app/errors.py` - 錯誤處理器
- `app/models.py` - 資料庫模型

---

### 2. 資料庫模型 (`app/models.py`)

**功能描述：**
定義整個點餐系統的資料庫結構，包含使用者、店家、菜單、訂單等所有資料模型。

**主要功能：**
- ✅ **使用者管理**
  - `User` - LINE Bot 使用者資料
  - `Language` - 系統支援的語言設定

- ✅ **店家管理**
  - `Store` - 店家基本資訊（包含合作等級）
  - `StoreTranslation` - 店家多語言翻譯

- ✅ **菜單管理**
  - `Menu` - 菜單版本管理
  - `MenuItem` - 菜單項目
  - `MenuTranslation` - 菜單多語言翻譯

- ✅ **訂單管理**
  - `Order` - 訂單主檔
  - `OrderItem` - 訂單項目

- ✅ **AI 處理**
  - `GeminiProcessing` - Gemini API 處理記錄
  - `VoiceFile` - 語音檔案管理

**資料結構特色：**
- 支援多語言翻譯
- 店家合作等級分類（VIP、合作、非合作）
- 完整的訂單追蹤系統
- AI 處理記錄保存

---

### 3. 錯誤處理系統 (`app/errors.py`)

**功能描述：**
提供全域錯誤處理、日誌記錄和 API 錯誤回應。

**主要功能：**
- ✅ **HTTP 錯誤處理**
  - 404 錯誤處理
  - 500 伺服器錯誤處理
  - 403 權限錯誤處理

- ✅ **API 錯誤處理**
  - 自定義 APIError 類別
  - 統一錯誤回應格式

- ✅ **日誌記錄系統**
  - 檔案日誌記錄
  - API 呼叫記錄
  - 使用者操作記錄

- ✅ **錯誤處理器註冊**
  - `register_error_handlers()` 函數

**相關檔案：**
- `app/__init__.py` - 錯誤處理器註冊

---

### 4. AI 提示詞工程 (`app/prompts.py`)

**功能描述：**
管理所有 AI 功能的提示詞，確保 Gemini API 的最佳回應品質。

**主要功能：**
- ✅ **菜單 OCR 提示詞**
  - 結構化菜單辨識
  - 多語言翻譯支援
  - 價格標準化

- ✅ **語音處理提示詞**
  - 語音指令辨識
  - 意圖識別
  - 實體提取

- ✅ **翻譯提示詞**
  - 多語言翻譯
  - 文化適應性

- ✅ **訂單摘要提示詞**
  - 訂單摘要生成
  - 結構化輸出

**特色功能：**
- 上下文感知提示詞
- 錯誤處理和回退機制
- 多語言支援
- 結構化輸出驗證

---

### 4.1 LangChain 強化功能 ⭐ **新增功能**

#### 4.1.1 LangChain 強化模組 (`app/langchain_enhancement.py`)

**功能描述：**
使用 LangChain 框架強化 AI 功能，提升答案準確度和系統穩定性。

**主要功能：**
- ✅ **記憶體管理 (Memory Management)**
  - `ConversationBufferMemory` - 記住完整對話歷史
  - `ConversationSummaryMemory` - 記住對話摘要
  - 支援上下文感知的回答

- ✅ **檢索增強生成 (RAG)**
  - 向量資料庫建立和管理
  - 知識庫檢索功能
  - 基於實際資料的回答

- ✅ **結構化輸出 (Structured Output)**
  - `PydanticOutputParser` - 結構化輸出解析
  - `ResponseSchema` - 回應格式定義
  - 完整驗證機制

- ✅ **鏈式處理 (Chains)**
  - `LLMChain` - 語言模型鏈
  - `ConversationChain` - 對話鏈
  - `RetrievalQA` - 檢索問答鏈

- ✅ **錯誤處理和回退**
  - 智能回退機制
  - 信心度評估
  - 多重驗證

**配置選項：**
```python
LangChainConfig(
    model_name="gemini-pro",
    temperature=0.1,
    memory_type="buffer",  # 或 "summary"
    enable_rag=True,
    enable_validation=True,
    enable_fallback=True
)
```

#### 4.1.2 AI 強化整合模組 (`app/ai_enhancement.py`)

**功能描述：**
整合 LangChain 強化功能到現有 AI 系統，提供統一的 AI 處理介面。

**主要功能：**
- ✅ **強化菜單 OCR 處理**
  - `process_menu_ocr()` - 強化版菜單辨識
  - 支援信心度評估
  - 自動回退機制

- ✅ **強化餐飲推薦**
  - `process_recommendation()` - 強化版推薦系統
  - 考慮用戶歷史偏好
  - 智能匹配店家特色

- ✅ **強化翻譯功能**
  - `process_translation()` - 強化版翻譯
  - 上下文感知翻譯
  - 文化適應性

- ✅ **強化查詢處理**
  - `process_general_query()` - 強化版查詢
  - 多輪對話支援
  - 智能回答生成

**便捷函數：**
```python
# 強化菜單 OCR
result = enhanced_menu_ocr("menu.jpg", "en")

# 強化餐飲推薦
result = enhanced_recommendation("我想要吃義大利料理")

# 強化翻譯
result = enhanced_translation("這家餐廳很好吃", "en", "餐飲評論")

# 強化查詢
result = enhanced_query("如何選擇餐廳？", "餐飲指南")
```

**記憶體管理：**
```python
# 獲取對話上下文
context = manager.get_conversation_context()

# 清除對話記憶
manager.clear_conversation_memory()

# 獲取處理統計
stats = manager.get_processing_stats()
```

#### 4.1.3 LangChain 測試腳本 (`test_langchain_enhancement.py`)

**功能描述：**
提供 LangChain 強化功能的完整測試和演示。

**主要功能：**
- ✅ **功能測試**
  - 餐飲推薦強化測試
  - 翻譯強化測試
  - 一般查詢強化測試
  - 對話記憶測試
  - 錯誤處理測試

- ✅ **性能比較**
  - LangChain 強化 vs 基礎處理
  - 準確度提升評估
  - 穩定性測試

- ✅ **實作指南**
  - 安裝和設定說明
  - 使用方式範例
  - 最佳實踐建議

#### 4.1.4 LangChain 說明文件 (`LANGCHAIN_ENHANCEMENT_GUIDE.md`)

**功能描述：**
提供詳細的 LangChain 強化功能說明和使用指南。

**主要內容：**
- ✅ **功能概述**
  - LangChain 強化功能介紹
  - 與基礎處理的比較
  - 性能提升說明

- ✅ **安裝和設定**
  - 依賴套件安裝
  - 環境變數設定
  - 配置選項說明

- ✅ **使用方式**
  - 基本使用範例
  - 便捷函數說明
  - 記憶體管理

- ✅ **最佳實踐**
  - 記憶體配置建議
  - RAG 知識庫管理
  - 錯誤處理策略
  - 性能監控

- ✅ **故障排除**
  - 常見問題解決
  - 調試技巧
  - 性能優化建議

---

### 5. API 端點模組 (`app/api/`)

#### 5.1 API 路由 (`app/api/routes.py`)

**功能描述：**
提供 LIFF 前端所需的 RESTful API 端點。

**主要功能：**

##### 店家相關 API
- ✅ `GET /api/stores/{store_id}` - 取得店家資訊（支援多語言）
- ✅ `GET /api/stores/check-partner-status` - 檢查店家合作狀態

##### 菜單相關 API
- ✅ `GET /api/menu/{store_id}` - 取得店家菜單（支援多語言）
- ✅ `POST /api/menu/process-ocr` - 處理菜單圖片 OCR

##### 訂單相關 API
- ✅ `POST /api/orders` - 建立訂單（合作店家）
- ✅ `POST /api/orders/temp` - 建立臨時訂單（非合作店家）
- ✅ `GET /api/orders/{order_id}/confirm` - 取得訂單確認資訊
- ✅ `GET /api/orders/{order_id}/voice` - 取得訂單語音檔
- ✅ `GET /api/orders/history` - 取得使用者訂單記錄
- ✅ `GET /api/orders/{order_id}/details` - 取得訂單詳細資訊

##### 語音相關 API
- ✅ `POST /api/voice/generate` - 生成自定義語音檔

##### 使用者相關 API
- ✅ `POST /api/users/register` - 使用者註冊

##### 測試 API
- ✅ `GET /api/test` - API 連線測試

#### 5.2 API 輔助函數 (`app/api/helpers.py`)

**功能描述：**
提供 API 路由的輔助函數，包含 AI 功能和檔案處理。

**主要功能：**

##### AI 功能
- ✅ `process_menu_with_gemini()` - 使用 Gemini API 處理菜單圖片
- ✅ `translate_text()` - 文字翻譯功能
- ✅ `translate_menu_items()` - 菜單項目翻譯
- ✅ `translate_store_info_with_db_fallback()` - 店家資訊翻譯

##### 語音功能
- ✅ `generate_voice_order()` - 生成訂單語音檔
- ✅ `generate_voice_from_temp_order()` - 生成臨時訂單語音檔
- ✅ `generate_voice_with_custom_rate()` - 自定義語速語音生成

##### 訂單功能
- ✅ `create_complete_order_confirmation()` - 建立完整訂單確認
- ✅ `send_complete_order_notification()` - 發送訂單通知
- ✅ `send_voice_control_buttons()` - 發送語音控制按鈕

##### 檔案處理
- ✅ `save_uploaded_file()` - 檔案上傳處理
- ✅ `get_nearby_stores_with_translations()` - 取得鄰近店家

---

### 6. LINE Bot Webhook 模組 (`app/webhook/`)

#### 6.1 Webhook 路由 (`app/webhook/routes.py`)

**功能描述：**
處理 LINE Bot 的 Webhook 請求，實現 LINE Bot 的核心功能。

**主要功能：**

##### 使用者管理
- ✅ `handle_follow()` - 處理新使用者加入好友
- ✅ `handle_new_user()` - 處理新使用者語言選擇
- ✅ `handle_existing_user()` - 處理現有使用者訊息

##### 位置服務
- ✅ `handle_location_message()` - 處理位置訊息
- ✅ `send_store_list()` - 發送店家清單
- ✅ `send_store_detail()` - 發送店家詳細資訊

##### 訂單管理
- ✅ `handle_order_history()` - 處理查詢訂單記錄
- ✅ `send_voice_order()` - 發送語音訂單到 LINE

##### 語音控制
- ✅ `handle_voice_control()` - 處理語音控制按鈕
- ✅ `handle_temp_voice_control()` - 處理臨時訂單語音控制

##### 推薦店家功能 ⭐ **新增功能**
- ✅ `is_food_request()` - 判斷是否為餐飲需求描述
- ✅ `handle_food_request()` - 處理餐飲需求並推薦店家
- ✅ `get_ai_recommendations()` - 使用 Gemini API 分析餐飲需求
- ✅ `send_recommendation_results()` - 發送推薦結果
- ✅ `handle_recommend_restaurants()` - 處理推薦店家請求

##### Postback 處理
- ✅ `handle_postback()` - 處理 Postback 事件
- ✅ `handle_store_detail()` - 處理店家詳細資訊查看
- ✅ `handle_start_ordering()` - 處理開始點餐
- ✅ `handle_back_to_list()` - 處理返回店家清單

**特色功能：**
- 多語言支援（中文、英文、日文、韓文）
- 智能需求識別
- AI 驅動推薦
- 優先級排序（VIP > 合作 > 非合作）

---

### 7. 管理後台模組 (`app/admin/`)

#### 7.1 管理路由 (`app/admin/routes.py`)

**功能描述：**
提供管理員後台功能，用於管理店家、菜單和查看統計資料。

**主要功能：**
- ✅ 管理員登入驗證
- ✅ 店家管理介面
- ✅ 菜單管理介面
- ✅ 訂單統計查看
- ✅ 系統設定管理

---

### 8. 前端模板 (`templates/`)

**功能描述：**
提供管理後台和錯誤頁面的 HTML 模板。

**主要功能：**
- ✅ 管理後台模板 (`templates/admin/`)
  - 儀表板頁面
  - 店家管理頁面
  - 菜單管理頁面
  - 訂單管理頁面
  - 報表頁面

- ✅ 錯誤頁面模板 (`templates/errors/`)
  - 404 錯誤頁面
  - 500 錯誤頁面

- ✅ LIFF 前端模板 (`templates/liff/`)

---

### 9. 靜態檔案 (`static/`)

**功能描述：**
提供 CSS、JavaScript 和圖片等靜態資源。

**主要功能：**
- ✅ CSS 樣式檔案 (`static/css/`)
  - 管理後台樣式
  - 響應式設計

- ✅ JavaScript 檔案 (`static/js/`)
  - 管理後台互動功能
  - 表單驗證

- ✅ 圖片資源 (`static/images/`)

---

### 10. 工具腳本 (`tools/`)

**功能描述：**
提供各種維護和開發工具。

**主要功能：**
- ✅ `manage_translations.py` - 翻譯管理工具
- ✅ `rebuild_database.py` - 資料庫重建工具

---

### 11. 測試和演示檔案

#### 11.1 功能測試 (`test_*.py`)

**功能描述：**
提供各種功能的測試腳本。

**主要檔案：**
- ✅ `test_recommendation.py` - 推薦店家功能測試
- ✅ `test_translation.py` - 翻譯功能測試
- ✅ `test_user_registration.py` - 使用者註冊測試
- ✅ `test_store_exploration.py` - 店家探索測試
- ✅ `test_non_partner_flow.py` - 非合作店家流程測試

#### 11.2 功能演示 (`demo_*.py`)

**功能描述：**
提供功能演示腳本。

**主要檔案：**
- ✅ `demo_recommendation.py` - 推薦店家功能演示

---

### 12. 部署和配置檔案

#### 12.1 部署配置
- ✅ `Dockerfile` - Docker 容器配置
- ✅ `cloudbuild.yaml` - Google Cloud Build 配置
- ✅ `requirements.txt` - Python 套件依賴
- ✅ `deploy.md` - 部署指南

#### 12.2 環境配置
- ✅ `.env` 檔案範例
- ✅ 環境變數說明

---

## 功能特色總結

### 🎯 核心功能
1. **智能點餐系統** - 支援合作和非合作店家
2. **多語言支援** - 中文、英文、日文、韓文
3. **AI 驅動推薦** - 使用 Gemini API 進行智能推薦
4. **語音功能** - 訂單語音生成和播放
5. **位置服務** - 基於位置的店家搜尋

### 🤖 AI 功能
1. **菜單 OCR 辨識** - 自動辨識菜單圖片
2. **智能翻譯** - 多語言菜單翻譯
3. **推薦引擎** - 基於需求的店家推薦
4. **語音處理** - 語音指令辨識
5. **LangChain 強化** ⭐ **新增功能**
   - 記憶體管理 - 記住對話歷史
   - 檢索增強生成 (RAG) - 知識庫檢索
   - 結構化輸出 - 確保格式一致性
   - 錯誤處理和回退 - 系統穩定性
   - 信心度評估 - 處理品質指標

### 📱 LINE Bot 功能
1. **多語言介面** - 支援四種語言
2. **位置分享** - 基於位置的店家搜尋
3. **語音控制** - 語音訂單播放
4. **訂單追蹤** - 完整的訂單歷史

### 🛠️ 管理功能
1. **店家管理** - 新增、編輯、刪除店家
2. **菜單管理** - 管理店家菜單
3. **訂單統計** - 查看訂單統計資料
4. **系統設定** - 管理系統配置

### 🔧 技術特色
1. **模組化設計** - 清晰的檔案結構
2. **錯誤處理** - 完整的錯誤處理機制
3. **日誌記錄** - 詳細的操作日誌
4. **API 文檔** - 完整的 API 端點
5. **測試覆蓋** - 全面的功能測試
6. **LangChain 整合** ⭐ **新增特色**
   - 先進的 AI 框架整合
   - 智能記憶體管理
   - 檢索增強生成技術
   - 結構化輸出驗證
   - 智能回退機制

## 部署需求

### 環境變數
```bash
# 資料庫設定
DATABASE_URL=your_database_url

# LINE Bot 設定
LINE_CHANNEL_ACCESS_TOKEN=your_line_bot_token
LINE_CHANNEL_SECRET=your_line_bot_secret

# Gemini API 設定
GEMINI_API_KEY=your_gemini_api_key

# Azure Speech Service 設定
AZURE_SPEECH_KEY=your_azure_speech_key
AZURE_SPEECH_REGION=your_azure_region
```

### 系統需求
- Python 3.8+
- Flask 框架
- SQLAlchemy ORM
- LINE Bot SDK
- Google Generative AI
- Azure Speech Service
- LangChain 框架 ⭐ **新增需求**
  - langchain==0.1.0
  - langchain-google-genai==0.0.6
  - langchain-community==0.0.10
  - faiss-cpu==1.7.4
  - pydantic==2.5.0

---

## 總結

這個後端系統提供了完整的點餐小幫手功能，從基本的店家管理到先進的 AI 推薦功能，所有功能都有清晰的程式碼結構和完整的文檔說明。系統採用模組化設計，便於維護和擴展。 